# シーン編集機能の提案

## 背景・課題

現在のシステムは「起承転結」の固定4シーン構成になっているが、ショートドラマなど柔軟な物語構成（例: 転転承結結）に対応したい。

```
現在: 起 → 承 → 転 → 結 (固定4シーン)
希望: 転 → 転 → 承 → 結 → 結 (自由な構成)
```

## ユーザーからの要望

各シーンの動画生成後のプレビュー画面（Review Step）で:

1. **シーン削除** - バツボタンでシーンを削除
2. **並べ替え** - ドラッグ&ドロップでシーンの順番を変更
3. **シーン追加** - 新しいシーンを追加して任意の位置に配置

---

## 提案A: シンプル案

### 概要
Review画面に削除・並べ替え・追加機能を追加（起承転結ラベルは維持）

### UI イメージ
```
Review画面での編集:
┌─────┬─────┬─────┬─────┐
│ ☰ ✕ │ ☰ ✕ │ ☰ ✕ │ ☰ ✕ │  ☰=ドラッグハンドル ✕=削除
│ 起  │ 承  │ 転  │ 結  │
│     │     │     │     │
└─────┴─────┴─────┴─────┘
                          [+ シーン追加]
```

### メリット
- 実装がシンプル
- 既存コードへの変更が最小限

### デメリット
- 「起承転結」のラベルが並べ替え後も残り、混乱する可能性
- 例: 「転」が最初に来ても「起」と表示されてしまう

### 実装工数
約2-3日

---

## 提案B: フリーフォーム案（推奨）

### 概要
起承転結のラベルをシンプルな「シーン番号」に変更し、完全に自由な構成を可能にする

### UI イメージ
```
Review画面:
┌─────┬─────┬─────┬─────┐
│ ☰ ✕ │ ☰ ✕ │ ☰ ✕ │ ☰ ✕ │
│ #1  │ #2  │ #3  │ #4  │  ← シンプルな番号表示
│     │     │     │     │
└─────┴─────┴─────┴─────┘
                    [+ シーン追加]

並び替え後、自動で番号が振り直される: #1, #2, #3...
```

### メリット
- 混乱がない（番号は常に順序を反映）
- どんな物語構成にも対応可能
- 実装も比較的シンプル
- ショートドラマ、CM、MVなど用途を選ばない

### デメリット
- 「起承転結」のガイダンスがなくなる
- 既存ユーザーは少し戸惑う可能性

### 実装工数
約3-4日

---

## 提案C: ハイブリッド案

### 概要
事前に物語構成テンプレートを選択でき、かつReview画面で自由に編集も可能

### UI イメージ
```
Step 1: 構成選択モーダル
┌────────────────────────────────┐
│ 物語構成を選んでください        │
│                                │
│ ○ 起承転結（標準4シーン）      │
│ ○ 序破急（3シーン）            │
│ ○ 5幕構成（5シーン）           │
│ ○ カスタム構成                 │
│   [転] [転] [承] [結] [結] [+] │
│                                │
│        [決定]                  │
└────────────────────────────────┘

Step 2: Review画面（提案Bと同様の編集機能）
```

### メリット
- AIが構成に合わせた最適なプロンプトを生成できる
- 初心者には構成テンプレート、上級者にはカスタム
- 最も柔軟性が高い

### デメリット
- 実装が複雑
- UIが複雑になる可能性

### 実装工数
約1-2週間

---

## 推奨案: 提案B（フリーフォーム案）

### 選定理由

| 観点 | 提案A | 提案B | 提案C |
|------|-------|-------|-------|
| 実装コスト | ◎ 低 | ○ 中 | △ 高 |
| UXシンプルさ | △ | ◎ | ○ |
| 柔軟性 | ○ | ◎ | ◎ |
| 混乱のなさ | △ | ◎ | ○ |
| 後方互換性 | ◎ | ○ | △ |

**結論**: 実装コストと柔軟性のバランスが最も良い提案Bを推奨

---

## 実装計画（提案B採用の場合）

### Phase 1: シーン削除機能
**工数: 0.5日**

#### フロントエンド
- Review画面の各シーンカードに削除ボタン（✕）追加
- 削除確認モーダル表示
- 削除後のUI更新

#### バックエンド
- `DELETE /api/v1/videos/storyboard/{id}/scenes/{scene_number}`
- DBからシーン削除
- 残りシーンの`scene_number`を振り直し

#### 注意点
- 最低1シーンは残す制約
- 削除したシーンを参照していたV2V設定のクリア

---

### Phase 2: ドラッグ&ドロップ並べ替え
**工数: 1-1.5日**

#### フロントエンド
- `@dnd-kit/core` または `react-beautiful-dnd` ライブラリ導入
- シーンカードにドラッグハンドル（☰）追加
- ドラッグ中のビジュアルフィードバック
- ドロップ後のAPI呼び出し

#### バックエンド
- `PATCH /api/v1/videos/storyboard/{id}/scenes/reorder`
- リクエストボディ: `{ "scene_order": [scene_id1, scene_id2, ...] }`
- DBの`scene_number`を新しい順序で更新

#### 注意点
- サブシーンは親シーンと一緒に移動
- 並べ替え後のV2V参照の更新

---

### Phase 3: シーン追加機能
**工数: 1-1.5日**

#### フロントエンド
- 「+ シーン追加」ボタン
- 新規シーン入力モーダル
  - 日本語説明入力
  - （オプション）画像アップロード
- 追加後、末尾に新シーンが表示
- Phase 2の並べ替えで位置調整

#### バックエンド
- `POST /api/v1/videos/storyboard/{id}/scenes`
- リクエストボディ: `{ "description_ja": "...", "image_url": "..." }`
- Geminiでrunway_prompt生成
- 画像生成 → 動画生成のフロー

#### 注意点
- 追加シーンの画像・動画生成は非同期
- 生成中の状態表示

---

### Phase 4: ラベル変更（オプション）
**工数: 0.5日**

- 起承転結ラベル → シーン番号（#1, #2, #3...）に変更
- または「起承転結」を残しつつ編集可能にする

---

## DB変更

### 現在のスキーマ
```sql
storyboard_scenes:
  - id (uuid)
  - storyboard_id (uuid)
  - scene_number (int)        -- 並び順
  - act (text)                -- 起/承/転/結
  - description_ja (text)
  - runway_prompt (text)
  - scene_image_url (text)
  - video_url (text)
  - ...
```

### 変更案
```sql
storyboard_scenes:
  - id (uuid)
  - storyboard_id (uuid)
  - display_order (int)       -- 表示順序（並べ替え用）← 追加
  - scene_number (int)        -- 元のシーン番号（後方互換用）
  - act (text)                -- 起/承/転/結（オプショナルに）
  - is_custom (boolean)       -- ユーザー追加シーンフラグ ← 追加
  - ...
```

---

## API設計

### シーン削除
```
DELETE /api/v1/videos/storyboard/{storyboard_id}/scenes/{scene_number}

Response: 200 OK
{
  "success": true,
  "remaining_scenes": 3
}
```

### シーン並べ替え
```
PATCH /api/v1/videos/storyboard/{storyboard_id}/scenes/reorder

Request:
{
  "scene_order": ["uuid1", "uuid2", "uuid3", "uuid4"]
}

Response: 200 OK
{
  "success": true,
  "scenes": [...]  // 新しい順序のシーン一覧
}
```

### シーン追加
```
POST /api/v1/videos/storyboard/{storyboard_id}/scenes

Request:
{
  "description_ja": "主人公が街を歩いている",
  "custom_image_url": "https://..." // オプション
}

Response: 201 Created
{
  "id": "new-scene-uuid",
  "scene_number": 5,
  "status": "pending",
  ...
}
```

---

## 次のステップ

1. 提案の承認
2. Phase 1（削除機能）から着手
3. 各Phase完了後にレビュー・テスト
4. 全Phase完了後に統合テスト
