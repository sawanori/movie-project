# Topaz API ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ä¿®æ­£ å®Ÿè£…è¨ˆç”»æ›¸

## æ¦‚è¦

### ç›®çš„
Topaz Video APIã®60fpså¤‰æ›ã‚’æ­£ã—ãå‹•ä½œã•ã›ã‚‹ãŸã‚ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®å½¢å¼ã‚’ä¿®æ­£ã™ã‚‹ã€‚

### ç¾çŠ¶ã®å•é¡Œ
ç¾åœ¨ã®å®Ÿè£…ã§ã¯`output`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒä¸è¶³ã—ã¦ãŠã‚Šã€APIå‘¼ã³å‡ºã—æ™‚ã«400ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã€‚

---

## âš ï¸ ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœï¼šç™ºè¦‹ã—ãŸå•é¡Œç‚¹

### ğŸ”´ Criticalï¼ˆå¿…é ˆä¿®æ­£ï¼‰

#### 1. output.frameRateã®å€¤ãŒä¸æ˜ç¢º
**å•é¡Œ**: å®Ÿè£…è¨ˆç”»æ›¸ã§ã¯`frameRate: 60`ã¨ã—ã¦ã„ã‚‹ãŒã€ã“ã‚ŒãŒæ­£ã—ã„ã‹ä¸æ˜ã€‚
- APIã‚µãƒ³ãƒ—ãƒ«ã§ã¯å…¥åŠ›ã¨åŒã˜å€¤ï¼ˆ24ï¼‰ã‚’ä½¿ç”¨
- `filters.fps: 60`ã¨ã®é–¢ä¿‚ãŒä¸æ˜ç¢º

**å¯¾ç­–**:
- å…¥åŠ›å‹•ç”»ã®frameRateã‚’ãã®ã¾ã¾ä½¿ç”¨ã™ã‚‹ã®ãŒå®‰å…¨
- 60fpså¤‰æ›ã¯`filters`ã§è¡Œã‚ã‚Œã‚‹ãŸã‚ã€`output.frameRate`ã¯å…ƒã®å€¤ã§ã‚ˆã„å¯èƒ½æ€§

#### 2. éŸ³å£°ãªã—å‹•ç”»ã¸ã®å¯¾å¿œ
**å•é¡Œ**: ç¾åœ¨ã®`_get_video_metadata`ã¯éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ç¢ºèªã—ã¦ã„ãªã„ã€‚
- éŸ³å£°ãŒãªã„å‹•ç”»ã§`audioTransfer: "Copy"`ã‚’æŒ‡å®šã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹å¯èƒ½æ€§

**å¯¾ç­–**:
- éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®æœ‰ç„¡ã‚’ç¢ºèªã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ 
- éŸ³å£°ãªã—ã®å ´åˆã¯`audioTransfer: "None"`ã¾ãŸã¯çœç•¥

#### 3. 401èªè¨¼ã‚¨ãƒ©ãƒ¼ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ¬ è½
**å•é¡Œ**: `interpolate_to_60fps`ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã«401ãŒãªã„ã€‚

**å¯¾ç­–**: èªè¨¼ã‚¨ãƒ©ãƒ¼ç”¨ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¿½åŠ 
```python
elif e.response.status_code == 401:
    raise TopazServiceError("APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
```

### ğŸŸ¡ Mediumï¼ˆæ¨å¥¨ä¿®æ­£ï¼‰

#### 4. _create_requestã®æœªä½¿ç”¨å¼•æ•°
**å•é¡Œ**: `video_url`å¼•æ•°ã‚’å—ã‘å–ã£ã¦ã„ã‚‹ãŒä½¿ç”¨ã—ã¦ã„ãªã„ã€‚

**å¯¾ç­–**: å¼•æ•°ã‚’å‰Šé™¤ã™ã‚‹ã‹ã€å°†æ¥ã®ç”¨é€”ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã§æ˜è¨˜

#### 5. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å•é¡Œ
**å•é¡Œ**: ffprobeå¤±æ•—æ™‚ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆ1080x1920, 30fpsç­‰ï¼‰ã‚’è¿”ã™ãŒã€å®Ÿéš›ã®å‹•ç”»ã¨ç•°ãªã‚‹å ´åˆAPIã‚¨ãƒ©ãƒ¼ã®åŸå› ã«ãªã‚‹ã€‚

**å¯¾ç­–**:
- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚ã¯ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã¦å‡¦ç†ã‚’ä¸­æ–­
- ã¾ãŸã¯ã€è­¦å‘Šãƒ­ã‚°ã‚’å¼·åŒ–ã—ã¦å•é¡Œã‚’å¯è¦–åŒ–

#### 6. å‹ã®ä¸æ•´åˆãƒªã‚¹ã‚¯
**å•é¡Œ**:
- `size`: APIã¯integerã‚’æœŸå¾…ã™ã‚‹ãŒã€è¨ˆç®—éç¨‹ã§floatã«ãªã‚‹å¯èƒ½æ€§
- `frameCount`: åŒæ§˜

**å¯¾ç­–**: æ˜ç¤ºçš„ãªintå¤‰æ›ã‚’è¿½åŠ 
```python
"size": int(video_metadata.get("size", 50000000)),
"frameCount": int(video_metadata.get("frameCount", 300)),
```

### ğŸŸ¢ Lowï¼ˆä»»æ„ä¿®æ­£ï¼‰

#### 7. dynamicCompressionLevelã®å€¤æ¤œè¨¼
**å•é¡Œ**: "High", "Medium", "Low"ã®ã©ã‚ŒãŒæœ€é©ã‹æœªæ¤œè¨¼

**å¯¾ç­–**: ãƒ†ã‚¹ãƒˆã§ç¢ºèªã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–

#### 8. containerãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å†—é•·æ€§
**å•é¡Œ**: `source.container`ã¨`output.container`ãŒå¸¸ã«åŒã˜å€¤

**å¯¾ç­–**: å¤‰æ•°ã§å…±é€šåŒ–ã—ã¦DRYåŸå‰‡ã‚’é©ç”¨

---

## å·®åˆ†åˆ†æ

### ç¾åœ¨ã®å®Ÿè£… (`topaz_service.py:201-236`)

```python
request_body = {
    "source": {
        "container": "mp4",
        "size": 50000000,
        "duration": 10.0,
        "frameCount": 300,
        "frameRate": 30.0,
        "resolution": {"width": 1080, "height": 1920},
    },
    "filters": [{
        "model": model,
        "fps": 60,
        "slowmo": 1,
        "duplicate": True,
        "duplicateThreshold": 0.1,
    }],
    "output": {
        "format": "mp4",      # âŒ ä¸æ­£ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å
        "compression": 18,    # âŒ ä¸æ­£ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å
    },
}
```

### APIãŒè¦æ±‚ã™ã‚‹ä»•æ§˜

```json
{
  "source": {
    "resolution": {"width": 800, "height": 448},
    "container": "mp4",
    "size": 477010,
    "duration": 4,
    "frameRate": 24,
    "frameCount": 97
  },
  "output": {
    "resolution": {"width": 800, "height": 448},
    "audioCodec": "AAC",
    "audioTransfer": "Copy",
    "frameRate": 24,
    "dynamicCompressionLevel": "High",
    "container": "mp4"
  },
  "filters": [{
    "model": "apo-8",
    "slowmo": 1,
    "fps": 60,
    "duplicate": true,
    "duplicateThreshold": 0.1
  }]
}
```

### ä¸è¶³ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸€è¦§

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | ç¾åœ¨ | å¿…è¦ | èª¬æ˜ |
|-----------|------|------|------|
| `output.resolution` | âŒ ãªã— | âœ… å¿…é ˆ | å‡ºåŠ›è§£åƒåº¦ (width, height) |
| `output.frameRate` | âŒ ãªã— | âœ… å¿…é ˆ | å‡ºåŠ›ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆ (å…ƒå‹•ç”»ã¨åŒã˜ or å¤‰æ›å¾Œ) |
| `output.audioCodec` | âŒ ãªã— | âœ… å¿…é ˆ | éŸ³å£°ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯ ("AAC") |
| `output.audioTransfer` | âŒ ãªã— | âœ… å¿…é ˆ | éŸ³å£°å‡¦ç†æ–¹æ³• ("Copy") |
| `output.dynamicCompressionLevel` | âŒ ãªã— | âœ… å¿…é ˆ | åœ§ç¸®ãƒ¬ãƒ™ãƒ« ("High", "Medium", "Low") |
| `output.container` | âŒ `format` | âœ… å¿…é ˆ | ã‚³ãƒ³ãƒ†ãƒŠå½¢å¼ ("mp4") |
| `output.format` | âœ… ã‚ã‚Š | âŒ ä¸æ­£ | å‰Šé™¤ãŒå¿…è¦ |
| `output.compression` | âœ… ã‚ã‚Š | âŒ ä¸æ­£ | å‰Šé™¤ãŒå¿…è¦ |

## ä¿®æ­£è¨ˆç”»ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼åæ˜ ç‰ˆï¼‰

### ä¿®æ­£å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ« | ä¿®æ­£å†…å®¹ |
|----------|----------|
| `movie-maker-api/app/services/topaz_service.py` | è¤‡æ•°ãƒ¡ã‚½ãƒƒãƒ‰ã®ä¿®æ­£ |

### ä¿®æ­£1: `_get_video_metadata`ãƒ¡ã‚½ãƒƒãƒ‰æ‹¡å¼µ

**è¿½åŠ å†…å®¹**: éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®æœ‰ç„¡ã‚’ç¢ºèª

```python
# éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’æ¢ã™
audio_stream = None
for stream in data.get("streams", []):
    if stream.get("codec_type") == "audio":
        audio_stream = stream
        break

metadata = {
    # ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ ...
    "hasAudio": audio_stream is not None,
}
```

### ä¿®æ­£2: `_create_request`ãƒ¡ã‚½ãƒƒãƒ‰ä¿®æ­£

**å¤‰æ›´å‰:**
```python
"output": {
    "format": "mp4",
    "compression": 18,
},
```

**å¤‰æ›´å¾Œ:**
```python
# éŸ³å£°è»¢é€è¨­å®šï¼ˆéŸ³å£°ãªã—å‹•ç”»ã«å¯¾å¿œï¼‰
audio_transfer = "Copy" if video_metadata.get("hasAudio", True) else "None"

"output": {
    "resolution": video_metadata.get("resolution", {"width": 1080, "height": 1920}),
    "frameRate": int(video_metadata.get("frameRate", 30)),  # å…ƒå‹•ç”»ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆ
    "audioCodec": "AAC",
    "audioTransfer": audio_transfer,
    "dynamicCompressionLevel": "High",
    "container": "mp4",
},
```

**æ³¨æ„**: `output.frameRate`ã¯å…ƒå‹•ç”»ã®å€¤ã‚’ä½¿ç”¨ã€‚60fpså¤‰æ›ã¯`filters.fps: 60`ã§è¡Œã‚ã‚Œã‚‹ã€‚

### ä¿®æ­£3: `interpolate_to_60fps`ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¿½åŠ 

**è¿½åŠ å†…å®¹:**
```python
elif e.response.status_code == 401:
    raise TopazServiceError("APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
```

### ä¿®æ­£4: å‹ã®æ˜ç¤ºçš„å¤‰æ›

**sourceéƒ¨åˆ†:**
```python
"source": {
    "container": video_metadata.get("container", "mp4"),
    "size": int(video_metadata.get("size", 50000000)),  # intæ˜ç¤º
    "duration": float(video_metadata.get("duration", 10.0)),  # floatæ˜ç¤º
    "frameCount": int(video_metadata.get("frameCount", 300)),  # intæ˜ç¤º
    "frameRate": float(video_metadata.get("frameRate", 30.0)),  # floatæ˜ç¤º
    "resolution": video_metadata.get("resolution", {"width": 1080, "height": 1920}),
},
```

### ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¬æ˜ï¼ˆä¿®æ­£ç‰ˆï¼‰

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | å€¤ | ç†ç”± |
|-----------|-----|------|
| `resolution` | å…ƒå‹•ç”»ã¨åŒã˜ | è§£åƒåº¦å¤‰æ›´ãªã— |
| `frameRate` | **å…ƒå‹•ç”»ã¨åŒã˜** | 60fpså¤‰æ›ã¯`filters`ã§è¡Œã‚ã‚Œã‚‹ |
| `audioCodec` | "AAC" | æ¨™æº–çš„ãªéŸ³å£°ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯ |
| `audioTransfer` | "Copy" or "None" | éŸ³å£°æœ‰ç„¡ã§å‹•çš„åˆ‡æ›¿ |
| `dynamicCompressionLevel` | "High" | é«˜å“è³ªåœ§ç¸® |
| `container` | "mp4" | MP4ã‚³ãƒ³ãƒ†ãƒŠ |

## ãƒ†ã‚¹ãƒˆè¨ˆç”»ï¼ˆä¿®æ­£ç‰ˆï¼‰

### 1. å˜ä½“ãƒ†ã‚¹ãƒˆ: ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£å½¢å¼
```bash
# ä¿®æ­£å¾Œã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã§APIã‚’å‘¼ã³å‡ºã—
# Status 200 or 201 ãŒè¿”ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆ400ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„ã“ã¨ï¼‰
```

### 2. å˜ä½“ãƒ†ã‚¹ãƒˆ: éŸ³å£°ãªã—å‹•ç”»
- éŸ³å£°ãªã—å‹•ç”»ã§audioTransfer: "None"ãŒè¨­å®šã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

### 3. å˜ä½“ãƒ†ã‚¹ãƒˆ: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- 401ã‚¨ãƒ©ãƒ¼æ™‚ã«é©åˆ‡ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã‚‹ã“ã¨ã‚’ç¢ºèª

### 4. çµ±åˆãƒ†ã‚¹ãƒˆ: å®Ÿéš›ã®60fpså¤‰æ›
- ãƒ†ã‚¹ãƒˆå‹•ç”»ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- 60fpså¤‰æ›ã‚’å®Ÿè¡Œ
- å¤‰æ›å¾Œã®å‹•ç”»ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ç¢ºèª
- ffprobeã§60fpsã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’æ¤œè¨¼

## å®Ÿè£…æ‰‹é †ï¼ˆä¿®æ­£ç‰ˆï¼‰

1. [ ] `_get_video_metadata`ã«éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒ ç¢ºèªã‚’è¿½åŠ 
2. [ ] `_create_request`ã®outputã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿®æ­£
3. [ ] `_create_request`ã®sourceã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å‹æ˜ç¤ºã‚’è¿½åŠ 
4. [ ] `interpolate_to_60fps`ã«401ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¿½åŠ 
5. [ ] å˜ä½“ãƒ†ã‚¹ãƒˆ: ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£å½¢å¼ç¢ºèª
6. [ ] å˜ä½“ãƒ†ã‚¹ãƒˆ: éŸ³å£°ãªã—å‹•ç”»ç¢ºèª
7. [ ] çµ±åˆãƒ†ã‚¹ãƒˆ: å®Ÿéš›ã®60fpså¤‰æ›

## ãƒªã‚¹ã‚¯ï¼ˆä¿®æ­£ç‰ˆï¼‰

| ãƒªã‚¹ã‚¯ | å½±éŸ¿åº¦ | å¯¾ç­– |
|--------|--------|------|
| APIä»•æ§˜å¤‰æ›´ | é«˜ | å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å®šæœŸç¢ºèª |
| output.frameRateã®å€¤ | ä¸­ | å…ƒå‹•ç”»ã®å€¤ã‚’ä½¿ç”¨ï¼ˆå®‰å…¨ç­–ï¼‰ |
| éŸ³å£°ãªã—å‹•ç”» | ä¸­ | hasAudioãƒ•ãƒ©ã‚°ã§å‹•çš„å¯¾å¿œ |
| ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•— | ä¸­ | ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚ã®è­¦å‘Šå¼·åŒ– |
| å‹ã®ä¸æ•´åˆ | ä½ | æ˜ç¤ºçš„ãªint/floatå¤‰æ› |

## å®Œäº†æ¡ä»¶ï¼ˆä¿®æ­£ç‰ˆï¼‰

- [ ] `_get_video_metadata`ãŒéŸ³å£°æœ‰ç„¡ã‚’è¿”ã™
- [ ] `_create_request`ãŒæ­£ã—ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’ç”Ÿæˆ
- [ ] 401ã‚¨ãƒ©ãƒ¼æ™‚ã«é©åˆ‡ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã‚‹
- [ ] APIå‘¼ã³å‡ºã—ã§400ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„
- [ ] 60fpså¤‰æ›ãŒæ­£å¸¸ã«å®Œäº†ã™ã‚‹
- [ ] éŸ³å£°ãªã—å‹•ç”»ã§ã‚‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„
